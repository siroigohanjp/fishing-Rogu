<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>釣りローグ — 釣りミニゲーム強化版</title>
<style>
  :root{
    --bg:#041622; --card:#07212a; --accent:#06b6d4; --muted:#9fb7c4;
    --danger:#ff6b6b; --success:#7ee3ff;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#02121a 0%, #042b34 60%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  h1{color:var(--accent);margin:0 0 8px 0}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:12px}

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);
  }
  .small{font-size:13px;color:var(--muted)}
  .stat{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .inventory{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}

  /* Fishing area */
  .fishing-area{display:flex;flex-direction:column;gap:10px}
  .pond{
    height:420px;border-radius:12px;padding:12px;background:
    radial-gradient(ellipse at 50% 10%, rgba(126,227,255,0.06) 0%, rgba(6,182,212,0.02) 30%, transparent 60%),
    linear-gradient(180deg,#03394a,#012028);
    position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)
  }
  /* water ripple (fish effect) */
  .ripple{position:absolute;border-radius:50%;pointer-events:none;mix-blend-mode:overlay;opacity:0.9}

  /* Line / rod visuals */
  .rod{
    position:absolute;left:12px;top:16px;width:200px;height:6px;border-radius:6px;background:linear-gradient(90deg,#123 0%, #234 100%);
    transform-origin:left center; z-index:30;
  }
  .line{
    position:absolute;left:200px;top:20px; width:2px;background:linear-gradient(180deg,#fff,#8fdfff);
    transform-origin: top center; z-index:25;
    box-shadow:0 0 6px rgba(126,227,255,0.1);
  }

  /* fish sprite (simple circle) */
  .fish{
    position:absolute;width:48px;height:24px;border-radius:24px;background:linear-gradient(90deg,#ffd97a,#ffb86b);
    transform-origin:center center; z-index:20;display:flex;align-items:center;justify-content:center;font-weight:700;color:#07212a;
    box-shadow:0 6px 18px rgba(0,0,0,0.4);
  }

  /* HUD */
  .hud-row{display:flex;gap:8px;align-items:center}
  .meter{height:14px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1;position:relative}
  .meter > .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));width:0%}
  .meter-label{font-size:13px;color:var(--muted);min-width:110px;text-align:left}
  .btn{background:var(--accent);color:#02121a;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .smallbtn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}

  /* fight UI */
  .fight-ui{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .control-row{display:flex;gap:8px}

  /* tension bar with safe zone */
  .tension-bar{position:relative;height:24px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
  .tension-fill{height:100%;background:linear-gradient(90deg,#ffd47a,#ff6b6b);width:0%}
  .safe-zone{position:absolute;top:0;height:100%;background:rgba(126,227,255,0.14);border-radius:6px}

  /* floating feedback */
  .toast{position:absolute;left:50%;top:8px;transform:translateX(-50%);padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.5);color:#fff;z-index:80}

  /* responsive */
  @media (max-width:880px){
    .layout{grid-template-columns:1fr; }
    .rod{left:8px}
  }

</style>
</head>
<body>
  <div class="wrap">
    <h1>釣りローグ — 釣りミニゲーム（強化版）</h1>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div class="small">操作: <strong>引く(Reel)</strong> と <strong>緩める(Slack)</strong> を押してテンションを管理</div>
      <button id="demoCatch" class="smallbtn">サンプル魚を釣る</button>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="stat"><div>所持金: <span id="gold">0</span> G</div><div class="small">レベル: <span id="level">1</span></div></div>

        <div style="margin-top:12px">
          <div class="small">装備</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <div class="smallbtn">ロッド: 素朴</div>
            <div class="smallbtn">ライン: 普通</div>
            <div class="smallbtn">餌: ワーム</div>
          </div>
        </div>

        <div style="margin-top:12px" class="panel">
          <div class="small">釣りログ</div>
          <div id="log" style="height:220px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px;font-size:13px"></div>
        </div>

      </div>

      <div class="panel fishing-area">
        <div class="small">釣り場: <strong id="destName">静かな湖</strong> — <span id="destEffect">魚の出やすい浅場</span></div>

        <div class="pond" id="pond">
          <!-- rod and line visuals -->
          <div class="rod" id="rodEl"></div>
          <div class="line" id="lineEl" style="height:120px;left:200px;top:20px"></div>

          <!-- fish placeholder -->
          <!-- dynamic fish elements will be appended here -->

          <!-- floating toast -->
          <div id="toast" class="toast" style="display:none"></div>
        </div>

        <!-- HUD / Fight UI -->
        <div class="fight-ui">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="meter-label">テンション</div>
            <div class="tension-bar" style="flex:1" id="tensionBar">
              <div class="tension-fill" id="tensionFill"></div>
              <div class="safe-zone" id="safeZone" style="left:40%;width:20%"></div>
            </div>
            <div style="min-width:70px;text-align:right" class="small">耐久: <span id="lineDur">100</span>%</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div class="meter-label">魚のHP</div>
            <div class="meter" style="flex:1"><div class="fill" id="fishHpFill" style="width:0%"></div></div>
            <div style="min-width:70px;text-align:right" class="small">残: <span id="fishHp">0</span></div>
          </div>

          <div class="control-row">
            <button id="reelBtn" class="btn">引く（Reel）</button>
            <button id="slackBtn" class="smallbtn">緩める（Slack）</button>
            <button id="steadyBtn" class="smallbtn">ステディ（小回復）</button>
            <div style="flex:1"></div>
            <div class="small">長押し不要 — クリックで操作</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
            <div class="small">フェーズ:</div><div id="phaseLabel" class="small">待機</div>
            <div style="flex:1"></div>
            <div class="small">目標テンション範囲: <span id="safeRangeLabel">40%〜60%</span></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/*
  高度化釣りミニゲーム
  - テンション管理（0〜100）
  - 安全域(safeZone)にテンションを保つとダメージを与える（引く成功）
  - 魚は複数ステートを持ち、パターンで強弱をつける
  - プレイヤー操作: 引く / 緩める / ステディ（小回復）
  - UIにアニメーションとフィードバック
  - 拡張しやすい構造（fishData, behaviors）
*/

/* ---------- ヘルパ ---------- */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

/* ---------- ゲーム状態 ---------- */
let state = {
  tension: 45,       // 0-100
  lineDur: 100,      // 0-100
  fish: null,
  inFight: false,
  safeZone: {left:40, width:20}, // in %
  pointer: {pos:0, dir:1}, // pointer on tension bar for visual (optional)
  timers: [],
};

const pond = qs("#pond");
const logEl = qs("#log");
const toastEl = qs("#toast");

/* ---------- 魚データ（拡張可） ---------- */
const fishDB = [
  {name:"ニジマス", hp:12, power:0.9, pattern:["idle","tug","idle","flee"], value:10},
  {name:"ブラックバス", hp:18, power:1.1, pattern:["idle","tug","pull","idle","dive"], value:22},
  {name:"ウナギ", hp:20, power:1.0, pattern:["idle","slip","tug","idle"], value:30},
  {name:"幻のフグ", hp:34, power:1.5, pattern:["tug","pull","panic","dive","tug"], value:80},
  {name:"深淵の鯨魚", hp:60, power:2.0, pattern:["pull","dive","pull","tug","pull","dive"], value:220}
];

/* ---------- 表示更新 ---------- */
function addLog(msg){
  const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  logEl.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>` + logEl.innerHTML;
}
function toast(msg, ttl=1200){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> toastEl.style.display = "none", ttl);
}
function escapeHtml(s){ return (s+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function renderHUD(){
  qs("#tensionFill").style.width = state.tension + "%";
  qs("#lineDur").textContent = Math.max(0,Math.round(state.lineDur));
  qs("#fishHp").textContent = state.fish ? Math.max(0,state.fish.hpCurrent) : 0;
  const hpPct = state.fish ? Math.max(0, (state.fish.hpCurrent / state.fish.hpMax) * 100) : 0;
  qs("#fishHpFill").style.width = hpPct + "%";
  // safe zone visuals
  qs("#safeZone").style.left = state.safeZone.left + "%";
  qs("#safeZone").style.width = state.safeZone.width + "%";
  qs("#safeRangeLabel").textContent = `${Math.round(state.safeZone.left)}%〜${Math.round(state.safeZone.left + state.safeZone.width)}%`;
}

/* ---------- 魚スポーン（戦闘開始） ---------- */
function spawnFish(fishDef){
  // create fish DOM
  clearFight();
  const fish = {
    def: fishDef,
    hpMax: fishDef.hp,
    hpCurrent: fishDef.hp,
    power: fishDef.power,
    pattern: [...fishDef.pattern], // cyclic pattern
    patternIndex: 0,
    x: 400, y: 160, angle:0
  };
  state.fish = fish;
  state.inFight = true;

  // fish element
  const fEl = document.createElement("div");
  fEl.className = "fish";
  fEl.textContent = fishDef.name.split("")[0]; // small label
  fEl.style.left = fish.x + "px";
  fEl.style.top = fish.y + "px";
  fEl.style.width = "64px";
  fEl.style.height = "28px";
  pond.appendChild(fEl);
  fish.el = fEl;

  addLog(`「${fishDef.name}」が食いついた！`);
  toast(`ファイト開始 — ${fishDef.name}`);
  // set a random safeZone center based on fish difficulty
  const zoneWidth = clamp(18 - fishDef.power*3, 10, 30);
  const left = clamp(rand(20,70), 10, 80 - zoneWidth);
  state.safeZone = {left, width:zoneWidth};

  // start fish behavior loop
  scheduleNextBehavior();
  renderHUD();
}

/* ---------- 行動ルーチン ---------- */
function scheduleNextBehavior(){
  if(!state.inFight || !state.fish) return;
  clearTimers();
  // determine next action from pattern
  const p = state.fish.pattern;
  const idx = state.fish.patternIndex % p.length;
  const action = p[idx];
  state.fish.patternIndex++;
  // durations differ by action
  let duration = 800 + rand(300,900);
  if(action === "idle") duration = 800 + rand(200,800);
  if(action === "tug") duration = 700 + rand(200,600);
  if(action === "pull") duration = 1000 + rand(300,800);
  if(action === "dive") duration = 1100 + rand(600,1200);
  if(action === "panic" || action === "flee") duration = 900 + rand(200,1200);

  // perform effect
  doFishAction(action);
  // schedule next
  state.timers.push(setTimeout(() => {
    scheduleNextBehavior();
  }, duration));
}

function doFishAction(action){
  if(!state.inFight || !state.fish) return;
  const f = state.fish;
  const el = f.el;
  const basePull = f.power * rand(3,6); // effect on tension
  // approximate effects:
  if(action === "idle"){
    // slight decrease in tension (fish rests)
    state.tension = clamp(state.tension - (0.2 + Math.random()*1.0), 0, 100);
    animateFish(el, 'idle');
    addLog("魚が息を潜めた…");
  } else if(action === "tug"){
    // quick snap: tension increases moderately
    state.tension = clamp(state.tension + basePull*1.6, 0, 100);
    state.lineDur = clamp(state.lineDur - (Math.random()*2 + 1), 0, 100);
    animateFish(el, 'tug');
    addLog("強い引き！"); 
  } else if(action === "pull"){
    // long pull: tension raises more and may damage line
    state.tension = clamp(state.tension + basePull*2.2, 0, 100);
    state.lineDur = clamp(state.lineDur - (Math.random()*4 + 2), 0, 100);
    animateFish(el, 'pull');
    addLog("突っ込み！ラインに負荷がかかる");
  } else if(action === "dive"){
    // dive reduces chance of reeling; tension may drop or spike
    if(Math.random() < 0.6){
      state.tension = clamp(state.tension + basePull*1.8, 0, 100);
      state.lineDur = clamp(state.lineDur - (Math.random()*6 + 3), 0, 100);
      addLog("潜られた！深く潜る");
    } else {
      state.tension = clamp(state.tension - (Math.random()*6 + 2), 0, 100);
      addLog("急に緩む…");
    }
    animateFish(el, 'dive');
  } else if(action === "slip" || action === "panic" || action === "flee"){
    // chance to escape if tension too low or too high
    if(Math.random() < 0.5){
      addLog("魚がもがいている…");
      animateFish(el, 'panic');
      state.tension = clamp(state.tension + rand(2,8), 0, 100);
      state.lineDur = clamp(state.lineDur - (Math.random()*3 + 1), 0, 100);
    } else {
      addLog("魚が落ち着いた…");
      animateFish(el, 'idle');
    }
  }
  // update visuals and check line break / escape
  renderHUD();
  checkLineOrEscape();
}

/* ---------- プレイヤー操作 ---------- */
qs("#reelBtn").addEventListener("click", ()=>{
  if(!state.inFight) return;
  // successful reel deals damage only if tension within safe zone
  const tzLeft = state.safeZone.left;
  const tzRight = tzLeft + state.safeZone.width;
  const t = state.tension;
  // reel action also increases tension
  state.tension = clamp(state.tension + rand(2,6), 0, 100);
  state.lineDur = clamp(state.lineDur - (Math.random()*1.4 + 0.6), 0, 100);
  // if in safe zone => apply damage
  if(t >= tzLeft && t <= tzRight){
    // damage scaled by player 'skill' (could include level)
    const dmg = Math.max(1, Math.round(rand(3,6) + (1 + Math.floor(rand(0,1))*1)));
    state.fish.hpCurrent = Math.max(0, state.fish.hpCurrent - dmg);
    addLog(`うまく合わせた！ 魚に ${dmg} のダメージ`);
    shakeFish(state.fish.el);
    if(state.fish.hpCurrent <= 0){
      winFight();
      return;
    }
  } else {
    // miss / bad timing: fish recovers / escapes a bit
    state.fish.hpCurrent = Math.min(state.fish.hpMax, state.fish.hpCurrent + rand(0,2));
    addLog("タイミングが合わない…魚が抵抗した");
  }
  renderHUD();
  checkLineOrEscape();
});

qs("#slackBtn").addEventListener("click", ()=>{
  if(!state.inFight) return;
  // slack decreases tension quickly, but may let fish escape if done incorrectly
  state.tension = clamp(state.tension - rand(6,14), 0, 100);
  // small chance fish takes advantage
  if(Math.random() < 0.06){
    state.lineDur = clamp(state.lineDur - (Math.random()*3 + 2), 0, 100);
    addLog("緩めた隙に魚が動いた！");
  } else {
    addLog("糸を緩めた — テンション低下");
  }
  renderHUD();
  checkLineOrEscape();
});

qs("#steadyBtn").addEventListener("click", ()=>{
  if(!state.inFight) return;
  // small positive effect: regain small lineDur and stabilize tension toward safe center
  const center = state.safeZone.left + state.safeZone.width/2;
  // move tension slightly toward center
  state.tension = clamp(state.tension + (center - state.tension) * 0.25, 0, 100);
  state.lineDur = clamp(state.lineDur + rand(2,5), 0, 100);
  addLog("ステディを使った：テンションが落ち着いた");
  renderHUD();
});

/* ---------- 勝利 / 敗北判定 ---------- */
function checkLineOrEscape(){
  if(!state.inFight || !state.fish) return;
  // if lineDur <=0 => break
  if(state.lineDur <= 0){
    endFight(false, "糸が切れた…");
    return;
  }
  // if tension >= 100 -> line snaps
  if(state.tension >= 100){
    endFight(false, "テンション過多で糸が切れた…");
    return;
  }
  // if tension <= 0 -> slack too much, fish may escape
  if(state.tension <= 0){
    // high chance to escape
    if(Math.random() < 0.6){
      endFight(false, "糸がたるんで魚が逃げた…");
      return;
    } else {
      addLog("糸がたるんだが、まだ保てている");
    }
  }
  // occasional passive line degradation
  state.lineDur = clamp(state.lineDur - (Math.random()*0.2), 0, 100);
}

function endFight(success, reason){
  // clear timers, remove fish, show result
  clearFight();
  if(success){
    addLog("勝利！魚を釣り上げた！");
    toast("釣り上げ成功！", 1500);
    // reward (stub)
  } else {
    addLog(reason || "逃げられた");
    toast(reason || "逃げられた", 1500);
  }
  // cleanup fish DOM if exists
  if(state.fish && state.fish.el){
    state.fish.el.remove();
  }
  state.fish = null;
  state.inFight = false;
  // reset tension slowly
  state.tension = clamp(state.tension * 0.6 + 30, 0, 100);
  renderHUD();
}

function winFight(){
  // award fish -> just a log and clear
  addLog(`「${state.fish.def.name}」を捕獲！報酬: ${state.fish.def.value}G`);
  toast("大物をゲット！", 1600);
  // TODO: add to inventory / gold
  clearFight();
  if(state.fish && state.fish.el) state.fish.el.remove();
  state.fish = null; state.inFight = false;
  // small post-win tension reduction
  state.tension = clamp(state.tension * 0.5 + 20, 0, 100);
  renderHUD();
}

/* ---------- タイマー管理とクリア ---------- */
function clearTimers(){
  while(state.timers.length) clearTimeout(state.timers.pop());
}
function clearFight(){
  clearTimers();
}

/* ---------- fish visual effects ---------- */
function animateFish(el, mode){
  if(!el) return;
  el.style.transition = "transform 200ms ease, left 300ms ease, top 350ms ease";
  if(mode === 'idle'){
    el.style.transform = 'rotate(0deg) scale(1)';
    el.style.left = (rand(320, 520)) + "px";
    el.style.top = (rand(120, 260)) + "px";
  } else if(mode === 'tug'){
    el.style.transform = 'rotate(-6deg) scale(1.04)';
    el.style.left = (rand(240, 420)) + "px";
    el.style.top = (rand(100, 240)) + "px";
  } else if(mode === 'pull'){
    el.style.transform = 'rotate(-10deg) scale(1.08)';
    el.style.left = (rand(180, 380)) + "px";
    el.style.top = (rand(80, 220)) + "px";
  } else if(mode === 'dive'){
    el.style.transform = 'rotate(8deg) scale(0.95)';
    el.style.left = (rand(260, 480)) + "px";
    el.style.top = (rand(180, 320)) + "px";
  } else if(mode === 'panic'){
    el.style.transform = 'rotate(14deg) scale(1.12)';
    el.style.left = (rand(200, 520)) + "px";
    el.style.top = (rand(60, 260)) + "px";
  }
  // ripple effect
  spawnRipple(parseInt(el.style.left||0)+10, parseInt(el.style.top||0)+10, 18 + Math.random()*20);
}
function shakeFish(el){
  if(!el) return;
  el.animate([
    {transform: 'translateX(0)'},
    {transform: 'translateX(-8px)'},
    {transform: 'translateX(8px)'},
    {transform: 'translateX(0)'}
  ], {duration:220, iterations:1});
}

function spawnRipple(x,y,size){
  const r = document.createElement("div");
  r.className = "ripple";
  r.style.left = (x - size/2) + "px";
  r.style.top = (y - size/2) + "px";
  r.style.width = size + "px";
  r.style.height = size + "px";
  r.style.background = "radial-gradient(circle, rgba(255,255,255,0.25), rgba(255,255,255,0.04))";
  r.style.opacity = 0.9;
  pond.appendChild(r);
  const anim = r.animate([
    {transform: 'scale(0.2)', opacity: 0.8},
    {transform: 'scale(1.8)', opacity: 0}
  ], {duration:900, easing:'ease-out'});
  anim.onfinish = ()=> r.remove();
}

/* ---------- pointer animation on tension (decorative) ---------- */
(function pointerLoop(){
  let dir = 1, pos=state.tension;
  function step(){
    // smooth approach towards current tension for visual
    pos += (state.tension - pos) * 0.08;
    qs("#tensionFill").style.width = pos + "%";
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();

/* ---------- デモ起動 / UI wiring ---------- */
qs("#demoCatch").addEventListener("click", ()=>{
  const f = fishDB[rand(0, fishDB.length-1)];
  spawnFish(f);
});

function renderHUDLoop(){
  renderHUD();
  requestAnimationFrame(renderHUDLoop);
}
requestAnimationFrame(renderHUDLoop);

/* ---------- 初期ガイド ---------- */
addLog("強化版ミニゲームへようこそ — 「引く」か「緩める」を操作してテンションを管理し、魚を釣り上げよう。");
addLog("安全域 (青い帯) にテンションを保つとダメージが通る。テンションが高すぎると糸が切れる。");

</script>
</body>
</html>
