<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>釣りローグ（Fishing Rogue）</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1220; --accent:#06b6d4; --muted:#94a3b8;
    --card:#071025; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
    background:linear-gradient(180deg,#071028 0%, #052233 60%, #02121a 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  .center{
    max-width:1100px;margin:24px auto;padding:18px;
  }
  /* Title screen */
  .title-screen{
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    gap:14px;
    min-height:60vh;
  }
  h1{
    font-size:48px;margin:0 0 6px 0; letter-spacing:4px; color:var(--accent);
    text-shadow:0 6px 24px rgba(0,0,0,0.6);
  }
  .btn{background:var(--accent); color:#02121a; border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;}
  .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06);}

  /* Game layout */
  .game{
    display:grid; grid-template-columns:260px 1fr 260px; gap:12px; align-items:start;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    min-height:120px;
  }
  .panel h2{font-size:16px;margin:0 0 8px 0;color:var(--muted);}
  .slot{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;}
  .flex{display:flex;gap:8px;align-items:center;}
  .inventory{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px;}
  .small{font-size:12px;color:var(--muted)}
  .dest-list{display:flex;flex-direction:column;gap:8px}
  .dest{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid transparent}
  .dest:hover{border-color:rgba(255,255,255,0.04)}
  .dest.active{outline:2px solid rgba(6,182,212,0.16)}

  /* Fishing area */
  .fishing-area{min-height:380px; display:flex;flex-direction:column;gap:12px;align-items:stretch;justify-content:flex-start;}
  .pond{flex:1;border-radius:12px;background:linear-gradient(180deg,#033042,#01202a);padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .hud{display:flex;gap:12px;align-items:center}
  .meter{height:14px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1;position:relative}
  .meter > .fill{height:100%;background:linear-gradient(90deg,#06b6d4,#7ee3ff);width:0%}
  .power-bar{height:10px;background:rgba(255,255,255,0.02);border-radius:6px;overflow:hidden;position:relative}
  .power-pointer{position:absolute;top:0;bottom:0;width:3px;background:#fff;opacity:0.9;left:0}

  /* modal */
  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;}
  .modal{background:#071428;padding:18px;border-radius:12px;max-width:420px;width:92%;}
  .row{display:flex;gap:8px;margin-top:10px;align-items:center}

  footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .smallbtn{font-size:13px;padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
</style>
</head>
<body>
  <div class="center" id="app">
    <!-- Title Screen -->
    <div id="titleScreen" class="title-screen">
      <h1>釣りローグ</h1>
      <div class="muted">未知の釣り場を探索し、伝説の魚を目指すローグライク釣りゲーム</div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button id="startBtn" class="btn">はじめる</button>
        <button id="initBtn" class="btn secondary">初期化</button>
      </div>
      <div class="small" style="margin-top:10px">※進行は自動セーブされます（localStorage）</div>
    </div>

    <!-- Main Game -->
    <div id="gameScreen" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="small">所持金: <span id="gold">0</span> G</div>
        <div>
          <button id="saveBtn" class="smallbtn">手動セーブ</button>
          <button id="backTitle" class="smallbtn">タイトルに戻る</button>
        </div>
      </div>

      <div class="game">
        <!-- left panel: equipment & inventory -->
        <div class="panel">
          <h2>装備</h2>
          <div id="equipList" class="slot">
            <div class="small">ロッド: <span id="equipRod">素朴な竿</span></div>
            <div class="small">リール: <span id="equipReel">標準リール</span></div>
            <div class="small">餌: <span id="equipBait">ワーム</span></div>
          </div>

          <h2 style="margin-top:8px">所持品</h2>
          <div class="inventory" id="inventory"></div>
          <div style="margin-top:8px">
            <button id="sellAll" class="smallbtn">魚を全部売る</button>
          </div>
        </div>

        <!-- center: fishing -->
        <div class="panel fishing-area">
          <h2>釣り場: <span id="currentDest">—</span></h2>
          <div class="pond" id="pond">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small">エリア効果: <span id="destEffect">—</span></div>
              <div class="small">時間: <span id="timeLabel">朝</span></div>
            </div>

            <div style="margin-top:12px">
              <div class="hud">
                <div style="width:120px">キャスト力</div>
                <div class="meter" id="castMeter"><div class="fill" id="castFill"></div><div class="power-pointer" id="castPointer" style="left:0"></div></div>
                <div style="width:120px;text-align:right"><button id="castBtn" class="btn" style="padding:6px 10px">キャスト</button></div>
              </div>

              <div style="margin-top:12px">
                <div class="small">釣果ログ</div>
                <div id="log" style="height:110px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:6px;font-size:13px"></div>
              </div>

              <div id="fightArea" style="margin-top:12px;display:none">
                <div class="small">ファイト！クリックで引きに耐えよう</div>
                <div class="power-bar" id="fightBar" style="margin-top:8px;position:relative">
                  <div id="targetZone" style="position:absolute;left:40%;width:20%;top:0;bottom:0;background:rgba(6,182,212,0.12)"></div>
                  <div id="pointer" style="position:absolute;left:0;top:0;bottom:0;width:3px;background:#fff"></div>
                </div>
                <div style="margin-top:8px;display:flex;gap:8px">
                  <button id="reelBtn" class="btn">引く</button>
                  <div class="small">魚体力: <span id="fishHP">0</span></div>
                  <div class="small">糸耐久: <span id="lineDur">100</span>%</div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- right panel: destinations -->
        <div class="panel">
          <h2>行先</h2>
          <div class="dest-list" id="destinations"></div>

          <h2 style="margin-top:10px">ステータス</h2>
          <div class="slot">
            <div class="small">HP: <span id="hp">100</span></div>
            <div class="small">スタミナ: <span id="stamina">100</span></div>
            <div class="small">釣り師レベル: <span id="playerLevel">1</span></div>
          </div>

        </div>
      </div>

      <footer>※この試作は拡張可能 — 装備・図鑑・永続強化などを追加できます。</footer>
    </div>

    <!-- modal for init choices -->
    <div id="initModal" style="display:none" class="modal-bg">
      <div class="modal">
        <div style="font-weight:700;font-size:18px">初期化</div>
        <div class="small" style="margin-top:8px">データを初期化します。どの範囲で初期化しますか？</div>

        <div class="row">
          <label><input type="radio" name="initOpt" value="once" checked> 今回のみ（セッション中だけ初期化）</label>
        </div>
        <div class="row">
          <label><input type="radio" name="initOpt" value="perma"> 恒久的にデータを消去（localStorageをクリア）</label>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="cancelInit" class="smallbtn">キャンセル</button>
          <button id="confirmInit" class="btn">実行</button>
        </div>
      </div>
    </div>

  </div>

<script>
/*
  Fishing Rogue - single-file prototype
  - Auto-save to localStorage
  - Title screen with init options
  - Basic UI: equipment, inventory, destinations
  - Fishing mini-game: cast power + fight meter
  Expand points are marked in comments.
*/

/* ---------- Utilities ---------- */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

const DEFAULT_STATE = () => ({
  gold: 50,
  hp: 100,
  stamina: 100,
  level: 1,
  equip: {rod: "素朴な竿", reel: "標準リール", bait: "ワーム"},
  inventory: [],
  currentDest: null,
  // destinations are regenerated each run; saved for persistence if desired
  destinations: generateDestinations(),
  timeOfDay: "朝", // 朝/昼/夜
});

function generateDestinations(){
  // simple list with effects
  const list = [
    {id:1,name:"静かな湖",effect:"魚の量↑、大型少なめ",tier:1},
    {id:2,name:"深淵の沼",effect:"レア魚の出現↑、危険度↑",tier:2},
    {id:3,name:"荒れた海岸",effect:"引きが強い魚が多い",tier:2},
    {id:4,name:"天空の池",effect:"幻の魚が出るかも",tier:3},
  ];
  return list;
}

/* ---------- State & Persistence ---------- */
let state = null;
const STORAGE_KEY = "fishing_rogue_save_v1";

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      const parsed = JSON.parse(raw);
      state = Object.assign(DEFAULT_STATE(), parsed);
      // ensure destinations exist
      if(!state.destinations) state.destinations = generateDestinations();
      return;
    }catch(e){
      console.error("load failed", e);
    }
  }
  state = DEFAULT_STATE();
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // visual feedback (small)
  qs("#saveBtn").textContent = "保存済み";
  setTimeout(()=> qs("#saveBtn").textContent = "手動セーブ", 1000);
}

/* ---------- UI helpers ---------- */
function renderAll(){
  qs("#gold").textContent = state.gold;
  qs("#hp").textContent = state.hp;
  qs("#stamina").textContent = state.stamina;
  qs("#playerLevel").textContent = state.level;
  qs("#equipRod").textContent = state.equip.rod;
  qs("#equipReel").textContent = state.equip.reel;
  qs("#equipBait").textContent = state.equip.bait;
  renderInventory();
  renderDestinations();
  if(state.currentDest){
    const d = state.destinations.find(x=>x.id===state.currentDest);
    if(d){
      qs("#currentDest").textContent = d.name;
      qs("#destEffect").textContent = d.effect;
    }
  } else {
    qs("#currentDest").textContent = "未選択";
    qs("#destEffect").textContent = "—";
  }
  qs("#timeLabel").textContent = state.timeOfDay;
  saveState(); // autosave on render
}

function renderInventory(){
  const el = qs("#inventory");
  el.innerHTML = "";
  if(state.inventory.length===0){
    el.innerHTML = '<div class="item small">所持品なし</div>';
    return;
  }
  state.inventory.forEach((it, idx)=>{
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${it.name}</div>
        <div class="small">${it.type} / 値：${it.value}G</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="smallbtn" data-idx="${idx}" onclick="sellItem(${idx})">売る</button>
        <button class="smallbtn" data-idx="${idx}" onclick="useItem(${idx})">使う</button>
      </div>
    </div>`;
    el.appendChild(d);
  });
}

window.sellItem = function(idx){
  const it = state.inventory[idx];
  if(!it) return;
  state.gold += Math.round(it.value * 0.9);
  log(`「${it.name}」を売却して ${Math.round(it.value*0.9)}G を入手`);
  state.inventory.splice(idx,1);
  renderAll();
}

window.useItem = function(idx){
  const it = state.inventory[idx];
  if(!it) return;
  if(it.type === "魚"){
    // 食べるとHP or スタミナ回復（例）
    state.hp = Math.min(100, state.hp + 8);
    state.stamina = Math.min(100, state.stamina + 12);
    log(`「${it.name}」を食べた。HPとスタミナが回復。`);
    state.inventory.splice(idx,1);
  } else {
    log(`「${it.name}」は今は使えない。`);
  }
  renderAll();
}

/* ---------- Destinations ---------- */
function renderDestinations(){
  const wrap = qs("#destinations");
  wrap.innerHTML = "";
  state.destinations.forEach(d=>{
    const el = document.createElement("div");
    el.className = "dest" + (state.currentDest===d.id ? " active":"");
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${d.name}</div>
        <div class="small">${d.effect}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="smallbtn" onclick="selectDest(${d.id})">選択</button>
        <button class="smallbtn" onclick="fastTravel(${d.id})">移動</button>
      </div>
    </div>`;
    wrap.appendChild(el);
  });
}

window.selectDest = function(id){
  state.currentDest = id;
  log("行先を選択しました。準備ができたらキャストしましょう。");
  renderAll();
}
window.fastTravel = function(id){
  // simulate travel cost/time
  const d = state.destinations.find(x=>x.id===id);
  if(!d) return;
  // cost increases with tier
  const cost = d.tier * 5;
  if(state.gold < cost){
    log("所持金が足りません（移動コスト: "+cost+"G）");
    return;
  }
  state.gold -= cost;
  state.currentDest = id;
  // change time randomly
  state.timeOfDay = ["朝","昼","夜"][rand(0,2)];
  // possible random event: gain item or small damage
  if(Math.random() < 0.15){
    state.hp = Math.max(0, state.hp - rand(1,6));
    log(`移動中に疲労。HPが少し減った（-${rand(1,6)}）`);
  }
  log(`${d.name} に移動しました（移動費 ${cost}G）`);
  renderAll();
}

/* ---------- Logging ---------- */
function log(msg){
  const el = qs("#log");
  const now = new Date();
  const t = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  el.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>` + el.innerHTML;
}

/* sanitize */
function escapeHtml(text){
  return (text+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ---------- Fishing core ---------- */
let castOsc = null;
let castPower = 0;
let casting = false;

function startCastOsc(){
  // pointer oscillates automatically
  const ptr = qs("#castPointer");
  let dir = 1;
  let pos = 0;
  casting = true;
  castOsc = setInterval(()=>{
    pos += dir * 2;
    if(pos > 100){ pos = 100; dir = -1; }
    if(pos < 0){ pos = 0; dir = 1; }
    ptr.style.left = pos + "%";
    castPower = pos;
    qs("#castFill").style.width = pos + "%";
  }, 20);
}

function stopCastOsc(){
  clearInterval(castOsc);
  castOsc = null;
  casting = false;
}

function attemptCast(){
  if(!state.currentDest){
    log("行先を選んでください。");
    return;
  }
  if(casting){
    // already in cast charge - interpret as stop and cast
    stopCastOsc();
    const power = castPower;
    log(`キャスト！力: ${Math.round(power)}%`);
    // determine distance/what fish based on power and dest tier
    const d = state.destinations.find(x=>x.id===state.currentDest);
    const tier = d ? d.tier : 1;
    // chance to get fish depends on power and tier
    const roll = Math.random()*100;
    const successThreshold = 25 + tier*15 - Math.abs(50-power)/2; // heuristic
    if(roll < successThreshold){
      // fish hooked => start fight
      const fish = generateFishForTier(tier);
      startFight(fish);
    } else {
      log("何も喰わなかった…");
      // small stamina cost / bait consumption
      state.stamina = Math.max(0, state.stamina - 3);
      renderAll();
    }
    return;
  }
  // start charge
  startCastOsc();
}

function generateFishForTier(tier){
  // simple sample fishes
  const pool = [
    {name:"ニジマス",tier:1,hp:8, value:8},
    {name:"コイ",tier:1,hp:10, value:10},
    {name:"ブラックバス",tier:2,hp:14,value:18},
    {name:"ウナギ",tier:2,hp:16,value:20},
    {name:"幻のフグ",tier:3,hp:26,value:60},
    {name:"深淵の鯨魚",tier:3,hp:40,value:120}
  ];
  // filter by tier-ish and pick random
  const candidates = pool.filter(f => Math.abs(f.tier - tier) <= 1);
  return JSON.parse(JSON.stringify(candidates[rand(0,candidates.length-1)])); // clone
}

/* ---------- Fight mini-game ---------- */
let fightState = null;
let fightInterval = null;

function startFight(fish){
  fightState = {
    fish: fish,
    fishHp: fish.hp,
    lineDur: 100,
    pointerPos: 0,
    dir: 1,
  };
  qs("#fishHP").textContent = fightState.fishHp;
  qs("#lineDur").textContent = fightState.lineDur.toFixed(0);
  qs("#fightArea").style.display = "block";
  // show target zone randomization
  const leftPct = rand(20,60);
  const widthPct = rand(12,30);
  qs("#targetZone").style.left = leftPct + "%";
  qs("#targetZone").style.width = widthPct + "%";
  // pointer move interval
  fightInterval = setInterval(()=>{
    fightState.pointerPos += fightState.dir * rand(1,4);
    if(fightState.pointerPos > 100){ fightState.pointerPos = 100; fightState.dir = -1; }
    if(fightState.pointerPos < 0){ fightState.pointerPos = 0; fightState.dir = 1; }
    qs("#pointer").style.left = fightState.pointerPos + "%";
    // passive changes: fish may pull line (decrease lineDur)
    if(Math.random() < 0.02){
      fightState.lineDur -= rand(0.5,1.8);
    }
    // if lineDur <= 0 => break
    if(fightState.lineDur <= 0){
      endFight(false, "糸が切れた…");
    }
    qs("#lineDur").textContent = Math.max(0, fightState.lineDur).toFixed(0);
  }, 30);
  // user must click 引く (reelBtn) repeatedly to deal damage while keeping pointer inside zone
}

function endFight(success, reason){
  clearInterval(fightInterval);
  fightInterval = null;
  qs("#fightArea").style.display = "none";
  if(success){
    // grant fish item
    const fish = fightState.fish;
    const item = {name:fish.name, type:"魚", value:fish.value};
    state.inventory.push(item);
    log(`「${fish.name}」を釣り上げた！ 値: ${fish.value}G`);
    // reward gold sometimes
    if(Math.random() < 0.15){
      const tip = Math.round(fish.value * 0.3);
      state.gold += tip;
      log(`${tip}G のボーナスを手に入れた！`);
    }
    // small xp -> level up
    state.level += Math.floor(fish.value / 50);
    if(state.level > 20) state.level = 20;
    renderAll();
  } else {
    log(reason || "逃げられた");
  }
  fightState = null;
}

/* reel button logic */
qs("#reelBtn").addEventListener("click", ()=>{
  if(!fightState) return;
  // check pointer inside target zone?
  const left = parseFloat(qs("#targetZone").style.left);
  const width = parseFloat(qs("#targetZone").style.width);
  const pos = fightState.pointerPos;
  if(pos >= left && pos <= left + width){
    // success hit => damage fish
    const dmg = rand(3,6) + Math.floor(state.level/3);
    fightState.fishHp -= dmg;
    // a successful reel also recovers line a bit
    fightState.lineDur = Math.min(100, fightState.lineDur + rand(1,3));
    qs("#fishHP").textContent = Math.max(0,fightState.fishHp);
    qs("#lineDur").textContent = Math.max(0,fightState.lineDur).toFixed(0);
    // if fishHp <=0 => win
    if(fightState.fishHp <= 0){
      endFight(true);
      return;
    }
  } else {
    // missed -> line degrades more and fish HP maybe recovers (escape attempt)
    fightState.lineDur -= rand(4,10);
    fightState.fishHp += rand(0,2); // wriggle
    qs("#lineDur").textContent = Math.max(0,fightState.lineDur).toFixed(0);
    qs("#fishHP").textContent = fightState.fishHp;
    // if line breaks
    if(fightState.lineDur <= 0){
      endFight(false, "糸が切れた…");
      return;
    }
    // if fish hp balloon beyond limit, it escapes
    if(fightState.fishHp > fightState.fish.hp * 1.5){
      endFight(false, "魚が逃げた…");
      return;
    }
  }
});

/* ---------- UI wiring ---------- */
qs("#startBtn").addEventListener("click", ()=>{
  // load and enter game
  loadState();
  qs("#titleScreen").style.display = "none";
  qs("#gameScreen").style.display = "block";
  renderAll();
  log("ゲームを開始しました。行先を選択してキャストしよう！");
});
qs("#backTitle").addEventListener("click", ()=>{
  qs("#gameScreen").style.display = "none";
  qs("#titleScreen").style.display = "flex";
});
qs("#saveBtn").addEventListener("click", ()=> saveState());

/* initial load to show title (don't auto-start) */
loadState();

/* init modal handling */
qs("#initBtn").addEventListener("click", ()=>{
  qs("#initModal").style.display = "flex";
});
qs("#cancelInit").addEventListener("click", ()=> qs("#initModal").style.display = "none");
qs("#confirmInit").addEventListener("click", ()=>{
  const opt = document.querySelector('input[name="initOpt"]:checked').value;
  if(opt === "once"){
    // temporary clear current runtime state (but keep localStorage)
    state = DEFAULT_STATE();
    qs("#initModal").style.display = "none";
    // if currently in-game, refresh UI
    qs("#titleScreen").style.display = "none";
    qs("#gameScreen").style.display = "block";
    renderAll();
    log("今回のみ初期化しました（localStorageは保持）。");
  } else {
    // permanent clear localStorage and reset
    localStorage.removeItem(STORAGE_KEY);
    state = DEFAULT_STATE();
    qs("#initModal").style.display = "none";
    qs("#titleScreen").style.display = "none";
    qs("#gameScreen").style.display = "block";
    renderAll();
    log("恒久的にデータを初期化しました。");
  }
});

/* cast button */
qs("#castBtn").addEventListener("click", ()=> attemptCast());

/* start/stop charging by clicking meter (optional) */
qs("#castMeter").addEventListener("click", ()=> attemptCast());

/* sell all fish */
qs("#sellAll").addEventListener("click", ()=>{
  const fishes = state.inventory.filter(i=>i.type==="魚");
  if(fishes.length===0){ log("売れる魚がありません。"); return; }
  const total = fishes.reduce((s,i)=>s+i.value,0);
  // remove fishes
  state.inventory = state.inventory.filter(i=>i.type!=="魚");
  state.gold += total;
  log(`魚を全部売却して ${total}G を入手した。`);
  renderAll();
});

/* manual save on unload */
window.addEventListener("beforeunload", ()=> saveState());

/* convenience: seed some items if empty on first start */
(function initialSeed(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    state = DEFAULT_STATE();
    state.inventory.push({name:"古いライン", type:"資材", value:6});
    state.inventory.push({name:"小さな魚（ニジマス）", type:"魚", value:8});
    saveState();
  }
})();

/* small helper to expose state for debugging (dev) */
window.__state = ()=> state;

</script>
</body>
</html>
